<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DSF Studio Pro - Ultimate Edition</title>
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; --border: #d2d2d7; }
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: var(--bg); overflow: hidden; }
        
        /* 左：ナビゲーション（スクロール対応） */
        #sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #thumb-container { flex: 1; overflow-y: auto; padding: 10px; }
        .thumb-wrap { width: 100%; margin-bottom: 15px; cursor: pointer; position: relative; }
        .thumb-canvas { width: 100%; aspect-ratio: 9/16; background: #eee; border: 3px solid transparent; border-radius: 4px; object-fit: cover; }
        .thumb-wrap.active .thumb-canvas { border-color: var(--primary); box-shadow: 0 0 8px rgba(0,122,255,0.3); }

        /* 中央：キャンバス */
        #editor-main { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 20px; }
        #canvas-view { position: relative; width: 360px; aspect-ratio: 9/16; background: #fff; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        #main-img { width: 100%; height: 100%; object-fit: cover; }
        .text-layer { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #fafafa; font-size: 24px; text-align: center; padding: 20px; box-sizing: border-box; }
        
        /* SVG吹き出し（縦書き対応） */
        .bubble-svg { position: absolute; transform: translate(-50%, -50%); cursor: move; }
        .bubble-svg.selected ellipse { stroke: var(--primary); stroke-width: 3; }
        .bubble-text { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 70%; text-align: center; font-size: 16px; pointer-events: none; color: #000; }
        .v-text { writing-mode: vertical-rl; text-orientation: upright; }

        /* 右：コントロール */
        #panel-right { width: 340px; background: #fff; border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .control-group { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 8px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding:10px; border-bottom:1px solid #eee;">
        <label style="font-size:11px;">サムネイルサイズ</label>
        <input type="range" min="50" max="100" value="100" oninput="resizeThumbs(this.value)">
    </div>
    <div id="thumb-container"></div>
    <div style="padding:10px;"><button class="btn" onclick="addSection()">+ セクション追加</button></div>
</div>

<div id="editor-main">
    <div id="canvas-view" onmousedown="handleCanvasClick(event)">
        <div id="content-render"></div>
        <div id="bubble-layer"></div>
    </div>
</div>

<div id="panel-right">
    <div class="control-group" style="background:#eef7ff;">
        <h4>プロジェクト管理</h4>
        <input type="text" id="project-id" placeholder="作品ID" style="width:100%; padding:8px; margin-bottom:10px;">
        <button class="btn" style="background:#34c759; color:#fff;" onclick="saveToCloud()">クラウドに保存</button>
        <button class="btn" style="background:var(--primary); color:#fff;" onclick="loadFromCloud()">読込</button>
    </div>

    <div class="control-group">
        <h4>セクション設定</h4>
        <label>タイプ</label>
        <select id="prop-type" onchange="update('type', this.value)" style="width:100%; margin-bottom:10px;">
            <option value="image">イメージセクション</option>
            <option value="text">テキストセクション</option>
        </select>
        
        <div id="image-only-props">
            <label>背景画像アップロード</label>
            <input type="file" accept="image/*" onchange="uploadToStorage(this)">
        </div>

        <label>文字の向き</label>
        <select id="prop-mode" onchange="update('writingMode', this.value)" style="width:100%; margin-bottom:10px;">
            <option value="horizontal-tb">横書き</option>
            <option value="vertical-rl">縦書き</option>
        </select>

        <label id="text-label">テキスト入力 (選択中の吹き出し or 背景テキスト)</label>
        <textarea id="prop-text" rows="5" style="width:100%;" oninput="updateActiveText(this.value)"></textarea>
        
        <button class="btn" style="margin-top:10px; background:#ff3b30; color:#fff;" onclick="deleteActive()">削除</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBj3U-wFkNsWlW1d4OHayerECMIRyhQ40o",
    authDomain: "vmnn-26345.firebaseapp.com",
    projectId: "vmnn-26345",
    storageBucket: "vmnn-26345.firebasestorage.app",
    messagingSenderId: "16688261830",
    appId: "1:16688261830:web:c218463dd6429774eb3c77",
    measurementId: "G-N6J9C3XCVQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  window.uploadToStorage = async (input) => {
    const file = input.files[0];
    if(!file) return;
    const storageRef = ref(storage, `dsf/${Date.now()}_${file.name}`);
    try {
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);
      update('background', url);
      alert("画像を保存しました！");
    } catch (e) { alert("保存失敗: " + e.message); }
  };

  window.saveToCloud = async () => {
    const pid = document.getElementById('project-id').value;
    if(!pid) return alert("作品IDを入力してください");
    await setDoc(doc(db, "works", pid), { sections: sections, lastUpdated: new Date() });
    alert("クラウド同期完了！");
  };

  window.loadFromCloud = async () => {
    const pid = document.getElementById('project-id').value;
    const snap = await getDoc(doc(db, "works", pid));
    if(snap.exists()) { sections = snap.data().sections; refresh(); }
  };
</script>

<script>
    let sections = [{ type: 'image', background: 'https://picsum.photos/id/10/600/1066', writingMode: 'horizontal-tb', bubbles: [], text: '' }];
    let activeIdx = 0;
    let activeBubbleIdx = null;

    function refresh() {
        const s = sections[activeIdx];
        const render = document.getElementById('content-render');
        
        // メインキャンバスの描画切り替え
        if(s.type === 'image') {
            render.innerHTML = `<img id="main-img" src="${s.background}">`;
            document.getElementById('image-only-props').style.display = 'block';
        } else {
            render.innerHTML = `<div class="text-layer ${s.writingMode === 'vertical-rl' ? 'v-text' : ''}">${s.text}</div>`;
            document.getElementById('image-only-props').style.display = 'none';
        }

        // 吹き出し描画
        document.getElementById('bubble-layer').innerHTML = (s.bubbles || []).map((b, i) => `
            <div class="bubble-svg ${i === activeBubbleIdx ? 'selected' : ''}" style="top:${b.y}%; left:${b.x}%;" onmousedown="selectBubble(event, ${i})">
                <svg width="150" height="120" viewBox="0 0 150 120">
                    <ellipse cx="75" cy="50" rx="65" ry="40" fill="white" stroke="black" stroke-width="2"/>
                    <path d="M 75 90 L ${75 + (b.tailX || 10)} ${90 + (b.tailY || 20)} L 95 85" fill="white" stroke="black" stroke-width="2"/>
                </svg>
                <div class="bubble-text ${s.writingMode === 'vertical-rl' ? 'v-text' : ''}">${b.text}</div>
            </div>
        `).join('');

        // パネルUIの同期
        document.getElementById('prop-type').value = s.type;
        document.getElementById('prop-mode').value = s.writingMode;
        document.getElementById('prop-text').value = (activeBubbleIdx !== null) ? s.bubbles[activeBubbleIdx].text : s.text;

        renderThumbs();
    }

    function renderThumbs() {
        document.getElementById('thumb-container').innerHTML = sections.map((s, i) => `
            <div class="thumb-wrap ${i === activeIdx ? 'active' : ''}" onclick="changeSection(${i})">
                ${s.type === 'image' ? `<img class="thumb-canvas" src="${s.background}">` : `<div class="thumb-canvas" style="display:flex;align-items:center;justify-content:center;font-size:10px;padding:5px;background:#fff;">${s.text}</div>`}
                <div style="position:absolute; top:5px; left:5px; background:white; font-size:10px; padding:2px; border:1px solid #ddd;">#${i+1}</div>
            </div>
        `).join('');
    }

    function changeSection(i) {
        activeIdx = i;
        activeBubbleIdx = null;
        refresh();
    }

    function addSection() { 
        sections.push({ type: 'image', background: 'https://via.placeholder.com/600x1066', writingMode: 'horizontal-tb', bubbles: [], text: '' });
        activeIdx = sections.length - 1; refresh(); 
    }

    function handleCanvasClick(e) {
        if(e.target.id !== 'main-img' && !e.target.classList.contains('text-layer')) return;
        const r = document.getElementById('canvas-view').getBoundingClientRect();
        sections[activeIdx].bubbles.push({
            x: ((e.clientX - r.left) / r.width * 100).toFixed(1),
            y: ((e.clientY - r.top) / r.height * 100).toFixed(1),
            tailX: 10, tailY: 20, text: "新しいセリフ"
        });
        activeBubbleIdx = sections[activeIdx].bubbles.length - 1;
        refresh();
    }

    function selectBubble(e, i) {
        e.stopPropagation();
        activeBubbleIdx = i;
        refresh();
        startDrag(e, i);
    }

    function update(k, v) { sections[activeIdx][k] = v; refresh(); }

    function updateActiveText(v) {
        if(activeBubbleIdx !== null) {
            sections[activeIdx].bubbles[activeBubbleIdx].text = v;
        } else {
            sections[activeIdx].text = v;
        }
        refresh();
    }

    function deleteActive() {
        if(activeBubbleIdx !== null) {
            sections[activeIdx].bubbles.splice(activeBubbleIdx, 1);
            activeBubbleIdx = null;
        } else if(sections.length > 1) {
            sections.splice(activeIdx, 1);
            activeIdx = Math.max(0, activeIdx - 1);
        }
        refresh();
    }

    function startDrag(e, i) {
        const container = document.getElementById('canvas-view').getBoundingClientRect();
        const move = (me) => {
            sections[activeIdx].bubbles[i].x = ((me.clientX - container.left) / container.width * 100).toFixed(1);
            sections[activeIdx].bubbles[i].y = ((me.clientY - container.top) / container.height * 100).toFixed(1);
            refresh();
        };
        const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
        window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
    }

    window.update = update;
    refresh();
</script>
</body>
</html>