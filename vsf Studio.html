<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Vacation Studio Pro</title>
    <style>
        :root { --primary: #007AFF; --sidebar-bg: #f8f9fa; --border: #ddd; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; overflow: hidden; background: #e9ecef; }
        
        #main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* 左：サムネイル */
        #sidebar-left { width: 180px; background: var(--sidebar-bg); border-right: 1px solid var(--border); overflow-y: auto; padding: 10px; }
        .thumb-item { width: 100%; aspect-ratio: 9/16; background: #eee; margin-bottom: 10px; border: 2px solid transparent; cursor: pointer; position: relative; overflow: hidden; }
        .thumb-item.active { border-color: var(--primary); }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; }

        /* 中央：メインエディタ（9:16固定） */
        #editor-center { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 20px; }
        #webtoon-canvas { 
            position: relative; 
            width: 450px; /* 表示上の幅 */
            aspect-ratio: 9 / 16; /* Webtoonの縦長アスペクト */
            background: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: hidden; 
        }
        #bg-image { width: 100%; height: 100%; object-fit: cover; cursor: crosshair; }

        /* 吹き出しレイヤー */
        .bubble {
            position: absolute;
            transform: translate(-50%, -50%);
            padding: 10px 15px;
            background: white;
            border: 2px solid black;
            cursor: move;
            user-select: none;
            min-width: 40px;
            text-align: center;
            font-size: 14px;
            line-height: 1.2;
        }
        .bubble.selected { outline: 3px solid var(--primary); }
        .bubble-shout { clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 85% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 85% 100%, 15% 100%, 15% 85%, 0% 85%); font-weight: bold; padding: 20px; }
        .bubble-mono { border-radius: 0; background: #fdfdfd; border: 1px solid #999; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }

        /* 右：プロパティパネル */
        #panel-right { width: 300px; background: white; border-left: 1px solid var(--border); overflow-y: auto; }
        .panel-section { padding: 15px; border-bottom: 1px solid var(--border); }
        h4 { margin: 0 0 10px 0; font-size: 13px; text-transform: uppercase; color: #666; }
        label { display: block; font-size: 11px; margin-bottom: 4px; color: #888; }
        input, textarea, select { width: 100%; margin-bottom: 12px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 13px; }

        /* 下：JSONドロワー */
        #drawer-bottom { height: 180px; background: #1e1e1e; color: #d4d4d4; display: flex; flex-direction: column; }
        .drawer-header { padding: 5px 15px; background: #333; display: flex; justify-content: space-between; font-size: 12px; }
        #json-view { flex: 1; padding: 10px; font-family: monospace; font-size: 11px; overflow: auto; white-space: pre-wrap; }

        .btn { padding: 8px; width: 100%; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; background: white; margin-bottom: 5px; }
        .btn-add { background: var(--primary); color: white; border: none; }
        .btn-del { color: #ff3b30; border-color: #ff3b30; }
    </style>
</head>
<body>

<div id="main-layout">
    <div id="sidebar-left">
        <div id="thumb-list"></div>
        <button class="btn btn-add" onclick="addSection()">+ 新規セクション</button>
    </div>

    <div id="editor-center">
        <div id="webtoon-canvas" onmousedown="handleCanvasClick(event)">
            <img id="bg-image" src="">
            <div id="bubbles-container"></div>
        </div>
    </div>

    <div id="panel-right">
        <div class="panel-section">
            <h4>セクション設定</h4>
            <label>タイプ</label>
            <select id="prop-type" onchange="updateSection('type', this.value)">
                <option value="image">イメージレイヤー</option>
                <option value="text">テキストレイヤー</option>
            </select>
            <label>背景画像URL</label>
            <input type="text" id="prop-bg" placeholder="URLを入力" oninput="updateSection('background', this.value)">
        </div>

        <div class="panel-section" id="section-text-props">
            <h4>本文 / キャプション設定</h4>
            <label>日本語</label>
            <textarea id="prop-content-ja" rows="3" oninput="updateContent('ja', this.value)"></textarea>
            <label>English</label>
            <textarea id="prop-content-en" rows="3" oninput="updateContent('en', this.value)"></textarea>
        </div>

        <div class="panel-section" id="bubble-detail-props" style="display:none;">
            <h4>吹き出し詳細プロパティ</h4>
            <label>種類</label>
            <select id="prop-bubble-type" onchange="updateBubble('type', this.value)">
                <option value="normal">標準</option>
                <option value="shout">叫び</option>
                <option value="mono">モノローグ</option>
            </select>
            <label>フォント</label>
            <input type="text" id="prop-font" oninput="updateBubble('font', this.value)">
            <button class="btn btn-del" onclick="deleteBubble()">吹き出しを削除</button>
        </div>
    </div>
</div>

<div id="drawer-bottom">
    <div class="drawer-header"><span>LIVE JSON VIEW</span><button onclick="copyJSON()">Copy</button></div>
    <div id="json-view"></div>
</div>

<script>
    let sections = [{ type: 'image', background: 'https://picsum.photos/id/1/600/1066', captions: [], content: {ja:"", en:""} }];
    let activeIdx = 0;
    let activeBubbleIdx = null;
    let isDragging = false;

    function addSection() {
        sections.push({ type: 'image', background: 'https://via.placeholder.com/600x1066', captions: [], content: {ja:"", en:""} });
        activeIdx = sections.length - 1;
        refresh();
    }

    function handleCanvasClick(e) {
        if (e.target.id !== 'bg-image') return;
        if (sections[activeIdx].type !== 'image') return;

        const rect = e.target.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;

        sections[activeIdx].captions.push({
            x: x.toFixed(1), y: y.toFixed(1),
            type: "normal", font: "default",
            content: { ja: "テキストを入力", en: "New Text" }
        });
        activeBubbleIdx = sections[activeIdx].captions.length - 1;
        refresh();
    }

    function refresh() {
        renderSidebar();
        renderCanvas();
        renderProps();
        document.getElementById('json-view').innerText = JSON.stringify(sections, null, 2);
    }

    function renderSidebar() {
        const list = document.getElementById('thumb-list');
        list.innerHTML = sections.map((s, i) => `
            <div class="thumb-item ${i===activeIdx?'active':''}" onclick="selectSection(${i})">
                <img src="${s.background}">
                <div style="position:absolute; bottom:2px; right:5px; color:white; font-size:10px; text-shadow:0 0 2px black;">#${i+1}</div>
            </div>
        `).join('');
    }

    function renderCanvas() {
        const s = sections[activeIdx];
        document.getElementById('bg-image').src = s.background;
        const container = document.getElementById('bubbles-container');
        
        if (s.type === 'text') {
            // テキストレイヤー表示
            container.innerHTML = `<div class="bubble" style="top:50%; left:50%; width:80%; background:rgba(255,255,255,0.8);">${s.content.ja || 'テキストを入力してください'}</div>`;
        } else {
            // イメージレイヤー（複数吹き出し）表示
            container.innerHTML = s.captions.map((c, i) => `
                <div class="bubble bubble-${c.type} ${i===activeBubbleIdx?'selected':''}" 
                     style="top:${c.y}%; left:${c.x}%; font-family:${c.font};"
                     onmousedown="startDrag(event, ${i})">
                    ${c.content.ja}
                </div>
            `).join('');
        }
    }

    function renderProps() {
        const s = sections[activeIdx];
        document.getElementById('prop-type').value = s.type;
        document.getElementById('prop-bg').value = s.background;

        const detail = document.getElementById('bubble-detail-props');
        
        if (s.type === 'image' && activeBubbleIdx !== null) {
            const b = s.captions[activeBubbleIdx];
            detail.style.display = 'block';
            document.getElementById('prop-bubble-type').value = b.type;
            document.getElementById('prop-font').value = b.font;
            document.getElementById('prop-content-ja').value = b.content.ja;
            document.getElementById('prop-content-en').value = b.content.en;
        } else {
            detail.style.display = 'none';
            document.getElementById('prop-content-ja').value = s.content.ja;
            document.getElementById('prop-content-en').value = s.content.en;
        }
    }

    function startDrag(e, idx) {
        e.stopPropagation();
        activeBubbleIdx = idx;
        isDragging = true;
        refresh();

        const onMouseMove = (me) => {
            if (!isDragging) return;
            const rect = document.getElementById('bg-image').getBoundingClientRect();
            let x = ((me.clientX - rect.left) / rect.width) * 100;
            let y = ((me.clientY - rect.top) / rect.height) * 100;
            sections[activeIdx].captions[activeBubbleIdx].x = x.toFixed(1);
            sections[activeIdx].captions[activeBubbleIdx].y = y.toFixed(1);
            renderCanvas();
            document.getElementById('json-view').innerText = JSON.stringify(sections, null, 2);
        };

        const onMouseUp = () => {
            isDragging = false;
            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
        };

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
    }

    function selectSection(i) { activeIdx = i; activeBubbleIdx = null; refresh(); }
    function updateSection(key, val) { sections[activeIdx][key] = val; refresh(); }
    function updateContent(lang, val) {
        if (sections[activeIdx].type === 'image' && activeBubbleIdx !== null) {
            sections[activeIdx].captions[activeBubbleIdx].content[lang] = val;
        } else {
            sections[activeIdx].content[lang] = val;
        }
        refresh();
    }
    function updateBubble(key, val) { sections[activeIdx].captions[activeBubbleIdx][key] = val; refresh(); }
    function deleteBubble() { sections[activeIdx].captions.splice(activeBubbleIdx, 1); activeBubbleIdx = null; refresh(); }
    function copyJSON() { navigator.clipboard.writeText(JSON.stringify(sections, null, 2)); alert("Copied!"); }

    refresh();
</script>
</body>
</html>