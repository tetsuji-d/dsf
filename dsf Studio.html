<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>DSF Studio Pro - Ultimate Edition</title>
    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; --border: #d2d2d7; }
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: var(--bg); overflow: hidden; }
        
        /* 左：ナビゲーション（スクロール改善） */
        #sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #thumb-container { flex: 1; overflow-y: auto; padding: 10px; }
        .thumb-wrap { width: 100%; margin-bottom: 15px; cursor: pointer; position: relative; }
        .thumb-canvas { width: 100%; aspect-ratio: 9/16; background: #eee; border: 2px solid transparent; border-radius: 4px; object-fit: cover; }
        .thumb-wrap.active .thumb-canvas { border-color: var(--primary); box-shadow: 0 0 8px rgba(0,122,255,0.3); }

        /* 中央：キャンバス */
        #editor-main { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 40px; }
        #canvas-view { position: relative; width: 400px; aspect-ratio: 9/16; background: #fff; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        #main-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* SVG吹き出し（動的制御） */
        .bubble-svg { position: absolute; transform: translate(-50%, -50%); cursor: move; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .bubble-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; text-align: center; font-size: 14px; pointer-events: none; }
        .v-text { writing-mode: vertical-rl; } /* 縦書き設定 */

        /* 右：コントロール */
        #panel-right { width: 340px; background: #fff; border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .control-group { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 8px; }
        .btn-success { background: #34c759; color: #fff; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding:10px; border-bottom:1px solid #eee;">
        <label>サムネイルサイズ</label>
        <input type="range" min="50" max="150" value="100" oninput="resizeThumbs(this.value)">
    </div>
    <div id="thumb-container"></div>
    <div style="padding:10px;">
        <button class="btn" style="background:#eee;" onclick="addSection()">+ セクション追加</button>
    </div>
</div>

<div id="editor-main">
    <div id="canvas-view" onmousedown="handleCanvasClick(event)">
        <img id="main-img" src="">
        <div id="bubble-layer"></div>
    </div>
</div>

<div id="panel-right">
    <div class="control-group" style="background:#eef7ff;">
        <h4>プロジェクト管理</h4>
        <input type="text" id="project-id" placeholder="作品ID">
        <button class="btn btn-success" onclick="saveToCloud()">クラウドに保存</button>
        <button class="btn" style="background:var(--primary); color:#fff;" onclick="loadFromCloud()">読込</button>
    </div>

    <div class="control-group">
        <h4>画像アップロード管理</h4>
        <input type="file" id="image-upload" accept="image/*" onchange="uploadImage(this)">
        <label>現在の画像URL</label>
        <input type="text" id="prop-bg" oninput="update('background', this.value)">
    </div>

    <div class="control-group">
        <h4>テキスト設定</h4>
        <select id="prop-mode" onchange="update('writingMode', this.value)">
            <option value="horizontal-tb">横書き (Horizontal)</option>
            <option value="vertical-rl">縦書き (Vertical)</option>
        </select>
        <textarea id="prop-ja" rows="4" oninput="updateContent(this.value)"></textarea>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  // --- Firebase Config ---
  const firebaseConfig = {
  apiKey: "AIzaSyBj3U-wFKnsWlwId4OHAyerEGMiRYhQN0o",
  authDomain: "vmnn-26345.firebaseapp.com",
  projectId: "vmnn-26345",
  storageBucket: "vmnn-26345.firebasestorage.app",
  messagingSenderId: "166808261830",
  appId: "1:166808261830:web:c218463dd04297749eb3c7",
  measurementId: "G-N639C3XCVQ"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // 画像アップロード機能
  window.uploadImage = async (input) => {
    const file = input.files[0];
    if(!file) return;
    const storageRef = ref(storage, `images/${Date.now()}_${file.name}`);
    try {
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);
      update('background', url);
      alert("画像をアップロードしました");
    } catch (e) { alert("アップロード失敗: " + e.message); }
  };

  window.saveToCloud = async () => { /* 前回同様 */ };
  window.loadFromCloud = async () => { /* 前回同様 */ };
</script>

<script>
    let sections = [{ background: 'https://picsum.photos/id/10/600/1066', writingMode: 'horizontal-tb', captions: [] }];
    let activeIdx = 0;
    let activeBubbleIdx = null;

    function refresh() {
        const s = sections[activeIdx];
        document.getElementById('main-img').src = s.background;
        document.getElementById('prop-mode').value = s.writingMode;
        
        // 吹き出し描画（SVGによる尾の制御の基礎）
        document.getElementById('bubble-layer').innerHTML = (s.captions || []).map((c, i) => `
            <div class="bubble-svg" style="top:${c.y}%; left:${c.x}%;" onmousedown="startDrag(event, ${i})">
                <svg width="120" height="80" viewBox="0 0 120 80">
                    <ellipse cx="60" cy="35" rx="55" ry="30" fill="white" stroke="black" stroke-width="2"/>
                    <path d="M 60 65 L 50 80 L 70 65" fill="white" stroke="black" stroke-width="2"/>
                </svg>
                <div class="bubble-text ${s.writingMode === 'vertical-rl' ? 'v-text' : ''}">${c.text}</div>
            </div>
        `).join('');

        renderThumbs();
    }

    function renderThumbs() {
        const container = document.getElementById('thumb-container');
        container.innerHTML = sections.map((s, i) => `
            <div class="thumb-wrap ${i === activeIdx ? 'active' : ''}" onclick="activeIdx=${i};refresh()">
                <img class="thumb-canvas" src="${s.background}">
                <div style="position:absolute; top:5px; left:5px; background:rgba(255,255,255,0.8); font-size:10px; padding:2px;">#${i+1}</div>
            </div>
        `).join('');
    }

    function resizeThumbs(val) {
        const wraps = document.querySelectorAll('.thumb-wrap');
        wraps.forEach(w => w.style.width = val + '%');
    }

    // 基本ロジックは前回同様
    function addSection() { 
        sections.push({ background: 'https://via.placeholder.com/600x1066', writingMode: 'horizontal-tb', captions: [] }); 
        activeIdx = sections.length - 1; refresh(); 
    }
    
    function update(k, v) { sections[activeIdx][k] = v; refresh(); }
    function updateContent(val) {
        if(activeBubbleIdx !== null) sections[activeIdx].captions[activeBubbleIdx].text = val;
        refresh();
    }

    // プレースホルダー関数（Firebase連携用）
    window.update = update;
    refresh();
</script>
</body>
</html>